---
title: "dose_response"
author: "Hana Akbarnejad"
date: "2/12/2020"
output: html_document
---

```{r setup, include=FALSE}

library(ResourceSelection)
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE)
```

## problem 1

In this problem we analyze the data collected from a bioassay study, where X is the dosage and Y is the number of animals that have died after taking the drug.

Because we have a binary ooutcome (dying versus not dying), we should model Y-X relationship using logit, probit, cloglog link functions. In this case, the probability of the outcome (dying) is denoted as p and n is the number of animals tested which is 30.

```{r}

# Problem 1-i

dose = c(0:4)
dying = c(2, 8, 15, 23, 27)
data1 = cbind(dose, dying)
data1 = as.data.frame(data1)
data1 %>% knitr::kable()

fit1 = glm(cbind(dying,30-dying)~dose, family=binomial(link='logit'))
fit2 = glm(cbind(dying,30-dying)~dose, family=binomial(link='probit'))
fit3 = glm(cbind(dying,30-dying)~dose, family=binomial(link='cloglog'))

### CI's
# CI for logit
vcov(fit1) # covariance of beta MLE (fisher information inverse)
beta=fit1$coefficients[2]
se=sqrt(vcov(fit1)[2,2]) # (same as in summary(glm_logit))
beta+c(qnorm(0.025),0,-qnorm(0.025))*se


# CI for probit
vcov(fit2) # covariance of beta MLE (fisher information inverse)
beta=fit2$coefficients[2]
se=sqrt(vcov(fit2)[2,2]) # (same as in summary(glm_logit))
beta+c(qnorm(0.025),0,-qnorm(0.025))*se

# CI for cloglog
vcov(fit3) # covariance of beta MLE (fisher information inverse)
beta=fit3$coefficients[2]
se=sqrt(vcov(fit3)[2,2]) # (same as in summary(glm_logit))
beta+c(qnorm(0.025),0,-qnorm(0.025))*se

### Deviance
summary(fit1)$deviance
summary(fit2)$deviance
summary(fit3)$deviance

### Predictions
predicted1 = predict(fit1, data.frame(dose = 0.01), type = 'response')
predicted2 = predict(fit2, data.frame(dose = 0.01), type = 'response')
predicted3 = predict(fit3, data.frame(dose = 0.01), type = 'response')

```

### Problem 1-i

In this part, we will model  $g(P(dying)) = \alpha + \beta X$ with logit, probit and complementary
log-log linkk and we are interested in calculating Estimate of $\beta$, 95% CI for $\beta$, Deviance, and $p\hat (dying | x = 0.01)$.

The table belows these estimates:

```{r table}

my_table = matrix(c("1.162", "0.686", "0.747", "(0.806,1.517)", "(0.497,0.876)", "(0.532,0.961)",
                    "0.379", "0.314", "2.230", "0.09", "0.0853", "0.128"), ncol=4, byrow = FALSE)
colnames(my_table) = c("beta_hat", "95% CI for beta", "Deviance", "p_hat(dying|x=0.01)")
rownames(my_table) = c("logit", "probit", "c-loglog")
my_table = as.table(my_table)
my_table %>%  knitr::kable()

```

COMMENT

## Problem 1-ii
In this part we want to estimate LD50 (the dose at which 50% of animals die) with 90% confidence interval based on models built based on logit, probit, c-loglog link functions (considering that X is in natural logarithm scale).

```{r}

## Problem 1-ii
# logit LD50 and CI
beta0=fit1$coefficients[1]
beta1=fit1$coefficients[2]
betacov=vcov(fit1) # inverse fisher information
x0fit=-beta0/beta1 
exp(x0fit) # point estimate of LD50  ## this is our xLD50?
varx0=betacov[1,1]/(beta1^2)+betacov[2,2]*(beta0^2)/(beta1^4)-2*betacov[1,2]*beta0/(beta1^3)
c(x0fit,sqrt(varx0)) # point est and se
exp(x0fit+c(qnorm(0.05),-qnorm(0.05))*sqrt(varx0)) # 95% CI for LD50

# probit LD50 and CI
beta0_1=fit2$coefficients[1]
beta1_1=fit2$coefficients[2]
betacov_1=vcov(fit2) # inverse fisher information
x0fit_1=-beta0_1/beta1_1 
exp(x0fit_1) # point estimate of LD50  ## this is our xLD50?
varx0_1=betacov_1[1,1]/(beta1_1^2)+betacov_1[2,2]*(beta0_1^2)/(beta1_1^4)-2*betacov_1[1,2]*beta0_1/(beta1_1^3)
c(x0fit_1,sqrt(varx0_1)) # point est and se
exp(x0fit_1+c(qnorm(0.05),-qnorm(0.05))*sqrt(varx0_1))

# cloglog LD50 and CI
beta0_2=fit3$coefficients[1]
beta1_2=fit3$coefficients[2]
betacov_2=vcov(fit3) # inverse fisher information
x0fit_2= (log(log(2))- beta0_2)/beta1_2 
exp(x0fit_2) # point estimate of LD50  ## this is our xLD50?
varx0_2=betacov_2[1,1]/(beta1_2^2)+betacov_2[2,2]*(beta0_2^2)/(beta1_2^4)-2*betacov_2[1,2]*beta0_2/(beta1_2^3)
c(x0fit_2,sqrt(varx0_2)) # point est and se
exp(x0fit_2+c(qnorm(0.05),-qnorm(0.05))*sqrt(varx0_2))
```

The table below shows the calculated amounts:

```{r table2}

my_table2 = matrix(c("7.389", "(5.509,9.909)", "7.43583", "(5.582,9.904)",
                     "8.841249", "(6.636,11.779)"), ncol=2, byrow = TRUE)
colnames(my_table2) = c("LD50 Estimate Exponentiated", "90% CI for LD50")
rownames(my_table2) = c("logit", "probit", "c-loglog")
my_table2 = as.table(my_table2)
my_table2 %>%  knitr::kable()
```


# Problem 2-i

how is the foodness of fit?
```{r}

# importing data
data = tibble(
  amount = seq(from = 10000, to = 90000, by = 5000),
  offered = c(4,6,10,12,39,36,22,14,10,12,8,9,3,1,5,2,1),
  enrolled = c(0,2,4,2,12,14,10,7,5,5,3,5,2,0,4,2,1)
)

# defining our x, y, m
x = data$amount
y = data$enrolled
m = data$offered

fit_glm = glm(cbind(y,m-y)~x, family=binomial(link='logit'))

library(ResourceSelection)
hl = hoslem.test(fit_glm$y, fitted(fit_glm), g=10) # fail to reject H0 >>> good fit!
```


# Problem 2-ii)
ii) How do you interpret the relationship between the scholarship amount
and enrollment rate? What is 95% CI?

interpretation:

The log odds ratio of enrollment changes by 3.095e-05 per 1 dollar increase in scholarship. Because we probably don't care about every dollar increase in scholarship, I change the scale and say that The log odds ratio of enrollment changes by 0.3095 per 10,000 dollars increase in scholarship amount.

```{r}

# 95% CI
beta_glm = fit_glm$coefficients[2]
se_glm = sqrt(vcov(fit_glm)[2,2])
beta_glm + c(qnorm(0.025),0,-qnorm(0.025))*se
```

????????? CI: (-2.144684e-01, 2.145303e-01)

# Problem 2-iii)
iii) How much scholarship should we provide to get 40% yield rate (the
percentage of admitted students who enroll?) What is the 95% CI?
```{r}

beta_0 = fit_glm$coefficients[1]
beta_1 = fit_glm$coefficients[2]
my_log = log (.4/.6) # -0.4054651
x0_estimate = (my_log - beta_0)/beta_1    # 40134.29$ scholarship should be offered to have 40% of people who get the                                            offer, enrol in the college

betacov_3 = vcov(fit_glm)  # covariance of beta_0 and beta_1 to gain the variance of the estimate
var_x0_estimate = betacov_3[1,1]/(beta_1^2) + betacov_3[2,2]*((beta_0 - log(0.4/0.6))^2)/(beta_1^4)-2*betacov_3[1,2]*(beta_0 - log(0.4/0.6))/(beta_1^3)

x0_estimate+c(qnorm(0.025),0,-qnorm(0.025))*sqrt(var_x0_estimate)

```

